<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>OCR + 笔记总结测试 v2.0</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .auth-section {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .upload-section {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        .upload-section:hover {
            border-color: #007bff;
        }
        .upload-section.dragover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .file-input {
            display: none;
        }
        .upload-btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .upload-btn:hover {
            background: #0056b3;
        }
        .progress-container {
            margin: 20px 0;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            width: 0%;
            transition: width 0.3s ease;
        }
        .status-text {
            margin-top: 10px;
            font-weight: bold;
            color: #333;
        }
        .result-section {
            margin-top: 20px;
            display: none;
        }
        .result-content {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }
        .action-buttons {
            margin-top: 15px;
            text-align: center;
        }
        .action-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 14px;
        }
        .action-btn:hover {
            background: #218838;
        }
        .action-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .summary-section {
            margin-top: 20px;
            display: none;
        }
        .summary-content {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .auth-status {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-weight: bold;
        }
        .auth-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .auth-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .log-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-entry {
            margin-bottom: 5px;
            font-size: 12px;
            color: #666;
        }
        .log-entry.error {
            color: #dc3545;
        }
        .log-entry.success {
            color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>OCR + 笔记总结测试</h1>
        
        <!-- 用户认证部分 -->
        <div class="auth-section">
            <h3>用户认证</h3>
            <div class="input-group">
                <label for="userId">用户ID:</label>
                <input type="text" id="userId" value="c992f3e6-2141-4f6c-ae49-6c2e0f67bb22" placeholder="请输入用户ID">
            </div>
            <div style="margin-top: 10px;">
                <button class="upload-btn" onclick="authenticateUser()">验证用户</button>
                <button class="upload-btn" onclick="skipAuthentication()" style="background-color: #6c757d;">跳过认证</button>
            </div>
            <div id="authStatus"></div>
        </div>

        <!-- 文件上传部分 -->
        <div class="upload-section" id="uploadSection">
            <h3>上传图片进行OCR识别</h3>
            <p>拖拽图片到此处或点击按钮选择文件</p>
            <input type="file" id="fileInput" class="file-input" accept="image/*">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">选择图片</button>
            <button class="upload-btn" onclick="uploadAndProcess()" id="processBtn" disabled>开始处理</button>
        </div>

        <!-- 进度显示 -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="status-text" id="statusText">等待开始...</div>
        </div>

        <!-- OCR结果显示 -->
        <div class="result-section" id="resultSection">
            <h3>OCR识别结果</h3>
            <div class="result-content" id="resultContent"></div>
            <div class="action-buttons">
                <button class="action-btn" onclick="startSummary()" id="summaryBtn">生成笔记总结</button>
                <button class="action-btn" onclick="copyResult()">复制结果</button>
            </div>
        </div>

        <!-- 笔记总结结果 -->
        <div class="summary-section" id="summarySection">
            <h3>笔记总结结果</h3>
            <div class="summary-content" id="summaryContent"></div>
        </div>

        <!-- 日志显示 -->
        <div class="log-section">
            <h4>操作日志</h4>
            <div id="logContainer"></div>
        </div>
    </div>

    <script>
        let currentUserId = null;
        let currentOcrResult = null;
        let currentContentId = null;
        let ocrWebSocket = null;
        let summaryWebSocket = null;

        // 添加日志
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 用户认证（简化版）
        async function authenticateUser() {
            const userId = document.getElementById('userId').value.trim();
            const authStatus = document.getElementById('authStatus');
            
            if (!userId) {
                authStatus.innerHTML = '<div class="auth-error">请输入用户ID</div>';
                return;
            }

            // 简单的UUID格式验证（可选）
            const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!uuidPattern.test(userId)) {
                authStatus.innerHTML = '<div class="auth-error">用户ID格式不正确（应为UUID格式）</div>';
                addLog('用户ID格式不正确', 'error');
                return;
            }

            // 直接认证成功
            currentUserId = userId;
            authStatus.innerHTML = '<div class="auth-success">用户认证成功</div>';
            addLog('用户认证成功', 'success');
            document.getElementById('processBtn').disabled = false;
        }

        // 跳过认证
        function skipAuthentication() {
            const userId = document.getElementById('userId').value.trim();
            const authStatus = document.getElementById('authStatus');
            
            // 如果没有输入用户ID，使用默认值
            if (!userId) {
                document.getElementById('userId').value = 'c992f3e6-2141-4f6c-ae49-6c2e0f67bb22';
                currentUserId = 'c992f3e6-2141-4f6c-ae49-6c2e0f67bb22';
            } else {
                currentUserId = userId;
            }
            
            authStatus.innerHTML = '<div class="auth-success">已跳过认证，使用测试用户ID</div>';
            addLog('已跳过用户认证', 'success');
            document.getElementById('processBtn').disabled = false;
        }

        // 文件选择处理
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                addLog(`已选择文件: ${file.name}`);
                document.getElementById('processBtn').disabled = !currentUserId;
            }
        });

        // 拖拽上传
        const uploadSection = document.getElementById('uploadSection');
        uploadSection.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                addLog(`已拖拽文件: ${files[0].name}`);
                document.getElementById('processBtn').disabled = !currentUserId;
            }
        });

        // 上传并处理图片
        async function uploadAndProcess() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                addLog('请先选择图片文件', 'error');
                return;
            }

            if (!currentUserId) {
                addLog('请先进行用户认证', 'error');
                return;
            }

            try {
                addLog('开始上传图片...');
                
                // 显示进度条
                document.getElementById('progressContainer').style.display = 'block';
                document.getElementById('resultSection').style.display = 'none';
                document.getElementById('summarySection').style.display = 'none';
                
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/v2/ocr/process-and-save', {
                    method: 'POST',
                    headers: {
                        'X-User-ID': currentUserId
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`上传失败: ${response.status}`);
                }

                const result = await response.json();
                currentContentId = result.content_id;
                
                addLog(`图片上传成功，任务ID: ${result.task_id}`, 'success');
                addLog(`内容ID: ${result.content_id}`, 'success');
                
                // 连接WebSocket监听处理进度
                connectOcrWebSocket(result.task_id);
                
            } catch (error) {
                addLog(`上传失败: ${error.message}`, 'error');
                document.getElementById('progressContainer').style.display = 'none';
            }
        }

        // 连接OCR WebSocket
        function connectOcrWebSocket(taskId) {
            const wsUrl = `ws://localhost:8000/api/v2/ocr/ws/${taskId}`;
            addLog(`连接WebSocket: ${wsUrl}`);
            console.log(`尝试连接WebSocket: ${wsUrl}`);
            
            ocrWebSocket = new WebSocket(wsUrl);
            
            ocrWebSocket.onopen = function() {
                addLog('WebSocket连接成功', 'success');
            };
            
            ocrWebSocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'status') {
                    updateProgress(data.progress, data.description);
                } else if (data.type === 'completed') {
                    updateProgress(100, '处理完成');
                    currentOcrResult = data.result.markdown;
                    showOcrResult(data.result.markdown);
                    addLog('OCR处理完成', 'success');
                } else if (data.type === 'failed') {
                    addLog(`OCR处理失败: ${data.error}`, 'error');
                    document.getElementById('progressContainer').style.display = 'none';
                }
            };
            
            ocrWebSocket.onerror = function(error) {
                addLog(`WebSocket错误: ${error}`, 'error');
            };
            
            ocrWebSocket.onclose = function() {
                addLog('WebSocket连接关闭');
            };
        }

        // 更新进度
        function updateProgress(progress, description) {
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('statusText').textContent = description;
        }

        // 显示OCR结果
        function showOcrResult(markdown) {
            document.getElementById('resultContent').textContent = markdown;
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('progressContainer').style.display = 'none';
        }

        // 开始笔记总结
        async function startSummary() {
            if (!currentContentId) {
                addLog('没有内容ID可以总结', 'error');
                return;
            }

            try {
                addLog('开始生成笔记总结...');
                
                const response = await fetch('/api/v2/note-summary-single/process?action=summarize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': currentUserId
                    },
                    body: JSON.stringify([currentContentId])
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`总结请求失败: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                addLog(`笔记总结任务创建成功，任务ID: ${result.task_id}`, 'success');
                
                // 连接WebSocket监听总结进度
                connectSummaryWebSocket(result.task_id);
                
            } catch (error) {
                addLog(`笔记总结失败: ${error.message}`, 'error');
            }
        }

        // 连接笔记总结WebSocket
        function connectSummaryWebSocket(taskId) {
            const wsUrl = `ws://localhost:8000/api/v2/note-summary-single/ws/${currentUserId}`;
            addLog(`连接总结WebSocket: ${wsUrl}`);
            
            summaryWebSocket = new WebSocket(wsUrl);
            
            summaryWebSocket.onopen = function() {
                addLog('总结WebSocket连接成功', 'success');
            };
            
            summaryWebSocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'progress') {
                    addLog(`总结进度: ${data.message}`);
                } else if (data.type === 'completed') {
                    showSummaryResult(data.result);
                    addLog('笔记总结完成', 'success');
                } else if (data.type === 'error') {
                    addLog(`笔记总结失败: ${data.message}`, 'error');
                }
            };
            
            summaryWebSocket.onerror = function(error) {
                addLog(`总结WebSocket错误: ${error}`, 'error');
            };
            
            summaryWebSocket.onclose = function() {
                addLog('总结WebSocket连接关闭');
            };
        }

        // 显示总结结果
        function showSummaryResult(result) {
            const summaryContent = document.getElementById('summaryContent');
            summaryContent.innerHTML = `
                <h4>总结标题: ${result.title || '无标题'}</h4>
                <div style="margin-top: 15px;">
                    <strong>总结内容:</strong>
                    <div style="margin-top: 10px; white-space: pre-wrap;">${result.summary || '无总结内容'}</div>
                </div>
                <div style="margin-top: 15px;">
                    <strong>关键词:</strong> ${result.keywords ? result.keywords.join(', ') : '无关键词'}
                </div>
            `;
            document.getElementById('summarySection').style.display = 'block';
        }

        // 复制结果
        function copyResult() {
            if (currentOcrResult) {
                navigator.clipboard.writeText(currentOcrResult).then(() => {
                    addLog('OCR结果已复制到剪贴板', 'success');
                }).catch(err => {
                    addLog('复制失败', 'error');
                });
            }
        }

        // 页面加载时自动验证用户
        window.onload = function() {
            addLog('页面加载完成');
            // 如果有预填的用户ID，自动验证
            const userId = document.getElementById('userId').value;
            if (userId) {
                authenticateUser();
            }
        };
    </script>
</body>
</html>